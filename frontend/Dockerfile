# Build stage
FROM node:16-alpine as build

WORKDIR /app

# Copy package.json
COPY package*.json ./

# Use npm install instead of npm ci since package-lock.json might not exist
RUN npm install

# Create required directories if they don't exist
RUN mkdir -p public src

# Copy source code
COPY . ./

# Ensure required files exist
RUN if [ ! -f ./public/index.html ]; then \
    echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Wiki Explorer</title></head><body><div id="root"></div></body></html>' > ./public/index.html; \
    fi

RUN if [ ! -f ./public/manifest.json ]; then \
    echo '{"short_name":"Wiki Explorer","name":"Wiki Explorer"}' > ./public/manifest.json; \
    fi

RUN if [ ! -f ./src/index.js ]; then \
    echo 'import React from "react"; import ReactDOM from "react-dom/client"; import "./index.css"; const root = ReactDOM.createRoot(document.getElementById("root")); root.render(<React.StrictMode><div>Wiki Explorer</div></React.StrictMode>);' > ./src/index.js; \
    fi

RUN if [ ! -f ./src/index.css ]; then \
    echo 'body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; }' > ./src/index.css; \
    fi

# Create placeholder image files
RUN if [ ! -f ./public/favicon.ico ]; then \
    echo "iVBORw0KGgoAAAANSUhEUgAAABAAAAAQEAYAAABPYyMiAAAABmJLR0T///////8JWPfcAAAACXBIWXMAAABIAAAASABGyWs+AAAAF0lEQVRIx2NgGAWjYBSMglEwCkbBSAcACBAAAeaR9cIAAAAASUVORK5CYII=" | base64 -d > ./public/favicon.ico; \
    fi

RUN if [ ! -f ./public/logo192.png ]; then \
    echo "iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAADAAAAAQADq8/hgAAAEaklEQVR42u3dbY9bVxnG8etZOzuzszuT7nZbCm2BqryUSlUCKnj/7wSBQEiAyhahUKCl3fbZzuPBTpwmbRrnwT7H8/19JOvFJvHctuSc6ygiAADYT7btDwAA20QAAHQcAZDc9XotVVXJ+fl52v79UqmUZSllWUoIQURkf//s7+/L3t6e7O3tSWvtwf2s6zrVunTnAL1eT25ubrZ+Tx8Oh1JVlZRluW2Cg++3rmuZzWbS7Xa/d/zZ2dmf/vjHP74dQohwjgBIgABI7vLyMj5//vwPb7/99s/G4/GT5XL5pLW2FxGPRCQkIiQiRETE5fwdRIRMJhP59ttv5dGjR9/77+/cuSMvvfSSvPDCC/d/9atf/e2NN9740O0bZQgBSK6ua3nnnXf+MP7ssx89ns//OR6P/9Na2/v/BRER2RcR/yPtslar1Uwmk/bk5CTwfSYAyIwAALq6a9euPfvDjz82AAAA9nOKNOh2B1KWZWytiiQS6fW689ls+q7WGBE4E0AuETLotXsXs9nFxfmTp5Adl0BJxTBMMs/n88X5dPqSVl3D+MPX5MV0Op1Od0tKywgAMnLOyeX5ucxmMxm2g27oVGXUdTcy6A5Mq018Pp93GBFyIgBpRYT0e0O5vDiXSCE2shOIaIhAjEKtiGp0fNnpdrtOpFMzDGRFAAxxLkTVenm5uJTJxeRsGz//Whw7N3n69OnlYnG7gh8RcZwJIDUOQSPOhSiS4qJXtda0Kq/Ei3Ecj8qQlZTOrdjSkRAASM3quog4RkQWDnxSyQ7eAgHQkQA28RoYuAECgOQ4/UdGBACGEABARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQA0EgBARwIAjQQA0JEAQCMBAHQkANBIAAAdCQC0/wFFw6X5tawhYAAAAABJRU5ErkJggg==" | base64 -d > ./public/logo192.png; \
    fi

RUN if [ ! -f ./public/logo512.png ]; then \
    echo "iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAAIAAAAAQABPCKwuAAADzklEQVR42u3dMW7bMBiG0e9HO3XqluFr9+49Qo/QI/QIPUKG7lk7d+rUDgb60zZlK1JI+jwbKQri5WuFNpsBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACzC0x9/fzfG97qq0kMAtEcNARBd/b/eH/anr+8OAYC26QcAJl//99NsQtsCAO1bpw8A7NT/Xj36CQDwNQB4pP53nZ8BkJ76B8AcYCoAAgBCUP8ACIEQABCAz/oBgEFUSQAI6V/DEADtF5wZALRfdAYB0H6xGQZA+0VmIkD7xWUoQPtFZTBA+8VkOED7RaQAQPvFowRABAQAQEAGAwEQAwMCAIjCYCBAQPvFYCBA+0UwO2CnWtDy39X3AEDrBTDroFZnGgB0XvimAXTeyRs9QgAdFr2zADoseFcCAF0VursBHVXi3TXp2wCAdgrb9wHQTlG7Q4BWitkXAtBGEftSEFooYB8MQuqC9dVgpC5UXw5IyiL17YCkLFCfD0q64vQFwaQsSl8RTLpidAEwKQvRJeCkLUKXgZOy+FwXQMqi8/MgpCw21weRssh8QRgpi8s3hJKysHxFMCmLyleEk7KgfEcA6QrJl4SQspB8SxApi8h3BZGyeHxZGCkLx7cFkrJofF0oKQvGD4aSsmD8YjApi8XPBpOyWPxwOCkLxS+HlLJQ/HRQKYvEbweVskD8eFgpi8OvB5ayOPx8eCkLw++HmLIw/IEYUxaGvxAnZXH4E7FSFoc/Ei1lcfgr8VIWhz8TMWVx+DsxUxaHPxQ1ZXH4S3FTFoe/FTllcdgAKYvDJkhZHDZCyuKwGVIWh/egPQAAAAAAEEuVBAAhCQSAgAQCQEACASAgcwYACRgEBEhQrVN9AeC3VgYBAQJQrQD83JL2CwD8ov0CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8GDnwzktl8O5Tg8C0ILDfrdrv/Hqfl+lBwGA9msEwPsA0P5uMpmPBgDt7y9nAWpnAaD9Pa4e/QQA+EoAvDRf3PVzUzevACw+APpva/++nx9aejMQlhwC5/tjM36YTiIZZeG9AADDEQCA1msEADTZEQEIQL9FIwABNj/NLQ4BAvDalAuA5i0DsNgAcPQPENR2OQIQgPZ/jkYAAgxgVinZAZgCmNtIBoCxwPmLwBiQI4ApisBjgJyGqASASQBzAZN6dOHXnohLlPBsQIBO/HaCgncmACAM3QcAAAAAAAAA2vIPvc5PUq3W0WQAAAAASUVORK5CYII=" | base64 -d > ./public/logo512.png; \
    fi

# Build the app
RUN npm run build

# Runtime stage (to be used if serving React directly, not through Django)
FROM nginx:alpine as runtime
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
